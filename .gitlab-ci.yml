image: alpine:latest

cache:
  paths:
    - node_modules/

stages:
  - build
  - test
  - deploy

# GitLab-CI Security Scans
include:
  - template: SAST.gitlab-ci.yml
  - template: License-Scanning.gitlab-ci.yml
  - template: Container-Scanning.gitlab-ci.yml
  - template: Dependency-Scanning.gitlab-ci.yml

sast:
  rules:
    - when: on_success
  needs: []

license_scanning:
  rules:
    - when: on_success
  needs: []

container_scanning:
  rules:
    - when: on_success
  needs: ["Container Scan Docker"]

dependency_scanning:
  dependencies:
    - Install Node Dependencies
  rules:
    - when: on_success
  needs: ["Install Node Dependencies"]

eslint-sast:
  rules:
    - when: on_success
  needs: []

gemnasium-dependency_scanning:
  rules:
    - when: on_success
  needs: []

nodejs-scan-sast:
  rules:
    - when: on_success
  needs: []    

retire-js-dependency_scanning:
  rules:
    - when: on_success
  needs: []

secrets-sast:
  rules:
    - when: on_success
  needs: []

# Workflow Default Settings
workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH

# Node.JS Testing
Install Node Dependencies:
  image: node:alpine
  stage: build
  script: npm i

# Build docker containers
Docker Master:
  # Official docker image.
  image: docker:latest
  stage: deploy
  dependencies:
    - Install Node Dependencies
  services:
    - docker:dind
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build --pull -t "$CI_REGISTRY_IMAGE" .
    - docker push "$CI_REGISTRY_IMAGE"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH'
      when: always
    - when: never

Build Docker:
  # Official docker image.
  image: docker:latest
  stage: deploy
  dependencies:
    - Install Node Dependencies
  services:
    - docker:dind
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build --pull -t $IMAGE_TAG .
    - docker push $IMAGE_TAG
  rules:
    - if: '$CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH'
      when: never
    - when: always

Container Scan Docker:
  # Official docker image.
  image: docker:latest
  stage: build
  services:
    - docker:dind
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build --pull -t $IMAGE_TAG .
    - docker push $IMAGE_TAG

# Cleaning up to make the container registry neater    
Cleanup Container Scan Docker Image:
  image: docker:latest
  stage: deploy
  services:
    - docker:dind
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHA
    REG_SHA256: ade837fc5224acd8c34732bf54a94f579b47851cc6a7fd5899a98386b782e228
    REG_VERSION: 0.16.1
  before_script:
    - apk add --no-cache curl
    - curl --fail --show-error --location "https://github.com/genuinetools/reg/releases/download/v$REG_VERSION/reg-linux-amd64" --output /usr/local/bin/reg
    - echo "$REG_SHA256  /usr/local/bin/reg" | sha256sum -c -
    - chmod a+x /usr/local/bin/reg
  script:
    - /usr/local/bin/reg rm -d --auth-url $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $IMAGE_TAG
  needs: ["container_scanning"]

# Deploy to heroku manually
Deploy to Heroku Prod:
  image: ruby:alpine
  stage: deploy
  dependencies:
    - Install Node Dependencies
  variables:
    MY_APP: ccn-covid19-sg-dashboard
  before_script:
    - apk add git curl
    - gem install dpl
    - echo "Deploying to Heroku"
  script: dpl --provider=heroku --app=$MY_APP --api-key=$HEROKU_KEY
  environment:
    name: Production
    url: https://covid19sg.itachi1706.com/
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH'
      when: manual
    - when: never
